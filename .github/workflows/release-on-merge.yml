name: Release on merge

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  release:
    if: github.event.pull_request.merged && !github.event.pull_request.head.repo.fork
    environment: production
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      version: ${{ steps.git-cliff-full.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate full changelog and bump version
        id: git-cliff-full
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: -v --bump --strip header
        env:
          OUTPUT: CHANGELOG.md
          GITHUB_REPO: ${{ github.repository }}

      - name: Bump `pyproject.toml` version (do not push yet)
        run: |
          VERSION=${{ steps.git-cliff-full.outputs.version }}
          VERSION_NO_V=${VERSION#v}
          echo "Setting project version to $VERSION_NO_V"
          python - <<PY
          from pathlib import Path
          import re, os
          version_no_v = os.environ.get('VERSION_NO_V', '0.1.0')
          p = Path('pyproject.toml')
          s = p.read_text(encoding='utf-8')
          s2 = re.sub(r'(?m)^version\\s*=\\s*".*"$', f'version = "{version_no_v}"', s)
          if s == s2:
              print("pyproject.toml already has desired version")
          else:
              p.write_text(s2, encoding='utf-8')
              print(f"pyproject.toml updated to version {version_no_v}")
          PY
        env:
          VERSION_NO_V: ${{ steps.git-cliff-full.outputs.version }}

      - name: Run tests
        run: make test

      - name: Commit version and changelog
        run: |
          git config user.name 'GitHub Actions'
          git config user.email 'github-actions@users.noreply.github.com'
          git add pyproject.toml CHANGELOG.md || true
          git commit -m "Bump version to ${{ steps.git-cliff-full.outputs.version }} [skip ci]" || echo "No changes to commit"
          git push

      - name: Tag version
        run: |
          git tag ${{ steps.git-cliff-full.outputs.version }} || echo "Tag already exists"
          git push --tags

  publish-docker:
    needs: release
    uses: ./.github/workflows/manual-docker-publish.yml
    with:
      version: ${{ needs.release.outputs.version }}
    permissions:
      contents: write
      packages: write
    secrets: inherit

  publish-pypi:
    needs: release
    uses: ./.github/workflows/manual-pypi-publish.yml
    with:
      version: ${{ needs.release.outputs.version }}
    permissions:
      contents: write
    secrets: inherit

  create-release:
    needs: [release, publish-docker, publish-pypi]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate current release notes
        # we use latest since we already created the tag in the `release` job
        id: git-cliff-current
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --latest -v --strip header
        env:
          GITHUB_REPO: ${{ github.repository }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build Linux binary (PyInstaller)
        run: |
          make build

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.git-cliff-current.outputs.version }}
          name: ${{ steps.git-cliff-current.outputs.version }}
          body: ${{ steps.git-cliff-current.outputs.content }}
          allowUpdates: true
          generateReleaseNotes: false
          artifacts: "dist/*.tar.gz"
